name: XFâ‚² Wallet iOS Build & Release

on:
  push:
    branches: [main, master]
    paths:
      - "lib/**"
      - "ios/**"
      - "pubspec.yaml"
      - ".github/workflows/ios-release.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "lib/**"
      - "ios/**"
      - "pubspec.yaml"
      - ".github/workflows/ios-release.yml"
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - debug
      upload_to_testflight:
        description: "Upload to TestFlight"
        required: false
        default: false
        type: boolean
      upload_to_app_store:
        description: "Upload to App Store"
        required: false
        default: false
        type: boolean
  release:
    types: [published]
    permissions:
      contents: write

env:
  FLUTTER_VERSION: "3.24.0"
  IOS_BUNDLE_ID: "com.fuego.fuego_wallet"
  IOS_SCHEME: "Runner"

jobs:
  build-ios:
    name: Build XFâ‚² Wallet (iOS)
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: Enable iOS support
        run: flutter config --enable-ios

      - name: Download xfg-stark-cli
        run: |
          curl -L -o xfg-stark-cli-macos.tar.gz "https://github.com/ColinRitman/xfgwin/releases/download/v0.8.8/xfg-stark-cli-macos.tar.gz"
          tar -xzf xfg-stark-cli-macos.tar.gz
          chmod +x xfg-stark-cli-macos
          mkdir -p assets/bin
          mv xfg-stark-cli-macos assets/bin/
          rm xfg-stark-cli-macos.tar.gz

      - name: Build fuego from source
        run: |
          # Clone HEAT branch
          git clone -b HEAT https://github.com/usexfg/fuego-suite.git fuego-source
          cd fuego-source

          # Install build dependencies
          brew install cmake pkg-config boost openssl zeromq jsoncpp

          # Build all executables
          mkdir build && cd build
          cmake .. -DBUILD_TESTS=OFF -DJSONCPP_INCLUDE_DIR=/usr/include -DCMAKE_CXX_FLAGS="-I/usr/include"
          make -j$(sysctl -n hw.ncpu)

          # Find and copy walletd binary
          mkdir -p ../../assets/bin
          find . -name "walletd" -type f -executable -exec cp {} ../../assets/bin/fuego-walletd \;
          chmod +x ../../assets/bin/fuego-walletd

      - name: Install dependencies
        run: flutter pub get

      - name: Download required binaries
        run: ./scripts/ensure-binaries.sh

      - name: Run tests
        run: flutter test

      - name: Analyze code
        run: flutter analyze

      - name: Setup iOS certificates and provisioning profiles
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Setup iOS provisioning profile
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        uses: apple-actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ env.IOS_BUNDLE_ID }}
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

      - name: Build iOS app (Debug)
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'debug')
        run: |
          flutter build ios --debug --no-codesign

      - name: Build iOS app (Release)
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          flutter build ios --release --no-codesign

      - name: Archive iOS app
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/Runner.xcarchive \
            archive

      - name: Export IPA
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist exportOptions.plist

      - name: Create export options plist
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cat > ios/exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF

      - name: Create IPA archive
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd ios/build/ipa
          zip -r XFâ‚²-Wallet-iOS-Release.ipa Runner.ipa
          cd ../../..

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-ios
          path: |
            ios/build/ipa/XFâ‚²-Wallet-iOS-Release.ipa
            build/ios/iphoneos/Runner.app
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ios/build/ipa/XFâ‚²-Wallet-iOS-Release.ipa
          tag_name: ${{ github.ref_name }}
          name: XFâ‚² Wallet iOS Release ${{ github.ref_name }}

  upload-to-testflight:
    name: Upload to TestFlight
    runs-on: macos-latest
    needs: build-ios
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_testflight == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-ios
          path: ./artifacts

      - name: Extract IPA
        run: |
          cd artifacts
          unzip XFâ‚²-Wallet-iOS-Release.ipa
          cd ..

      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: artifacts/Runner.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

  upload-to-app-store:
    name: Upload to App Store
    runs-on: macos-latest
    needs: build-ios
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_app_store == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-ios
          path: ./artifacts

      - name: Extract IPA
        run: |
          cd artifacts
          unzip XFâ‚²-Wallet-iOS-Release.ipa
          cd ..

      - name: Upload to App Store
        uses: apple-actions/upload-app-store@v1
        with:
          app-path: artifacts/Runner.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

  security-scan:
    name: Security Scan
    runs-on: macos-latest
    needs: build-ios
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download IPA artifact
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-ios
          path: ./artifacts

      - name: Extract IPA for analysis
        run: |
          cd artifacts
          unzip XFâ‚²-Wallet-iOS-Release.ipa
          cd ..

      - name: Run iOS security analysis
        run: |
          # Basic security checks for iOS app
          echo "Running iOS security analysis..."

          # Check for hardcoded secrets
          echo "Checking for hardcoded secrets..."
          if grep -r "password\|secret\|key\|token" ios/Runner/ --include="*.swift" --include="*.m" --include="*.h" | grep -v "//"; then
            echo "âš ï¸ Potential hardcoded secrets found"
          else
            echo "âœ… No hardcoded secrets found"
          fi

          # Check Info.plist for security configurations
          echo "Checking Info.plist security configurations..."
          if grep -q "NSAppTransportSecurity" ios/Runner/Info.plist; then
            echo "âœ… ATS configuration found"
          else
            echo "âš ï¸ ATS configuration not found"
          fi

          # Check for debug configurations in release build
          echo "Checking for debug configurations..."
          if grep -q "DEBUG" ios/Runner/Info.plist; then
            echo "âš ï¸ Debug configurations found in release build"
          else
            echo "âœ… No debug configurations found"
          fi

      - name: Run Flutter security analysis
        run: |
          # Run Flutter security analysis
          flutter analyze --fatal-infos

          # Check for known security issues in dependencies
          flutter pub deps --json | jq -r '.packages[] | select(.kind == "direct") | .name' > direct_deps.txt
          echo "Direct dependencies:"
          cat direct_deps.txt

  code-quality:
    name: Code Quality Analysis
    runs-on: macos-latest
    needs: build-ios
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Run comprehensive analysis
        run: |
          # Run Flutter analyze with all checks
          flutter analyze --fatal-infos

          # Run tests with coverage
          flutter test --coverage

          # Generate coverage report
          genhtml coverage/lcov.info -o coverage/html

          # Check test coverage
          lcov --summary coverage/lcov.info

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: ios-coverage-report
          path: coverage/
          retention-days: 30

  notify-release:
    name: Notify Release
    runs-on: macos-latest
    needs: [build-ios, upload-to-testflight, upload-to-app-store]
    if: always() && github.event_name == 'release'

    steps:
      - name: Notify Discord
        if: env.DISCORD_WEBHOOK_URL != ''
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ðŸš€ **XFâ‚² Wallet iOS Release ${{ github.ref_name }}**

            âœ… iOS app build completed
            ðŸ“± Ready for distribution
            ðŸ”— [Download from GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})

            **Build Details:**
            - Version: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            - Platform: iOS

      - name: Create Release Summary
        run: |
          echo "## XFâ‚² Wallet iOS Release ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… iOS App: Built and signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code quality: Analyzed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.upload-to-testflight.result }}" == "success" ]; then
            echo "- âœ… TestFlight: Uploaded successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ TestFlight: Upload skipped or failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.upload-to-app-store.result }}" == "success" ]; then
            echo "- âœ… App Store: Uploaded successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ App Store: Upload skipped or failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- [iOS IPA](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/XFâ‚²-Wallet-iOS-Release.ipa)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the iOS app on physical devices" >> $GITHUB_STEP_SUMMARY
          echo "2. Submit for App Store review (if uploaded)" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor TestFlight feedback (if uploaded)" >> $GITHUB_STEP_SUMMARY
