name: XFâ‚² Wallet Android Build & Release

on:
  push:
    branches: [main, master]
    paths:
      - "lib/**"
      - "android/**"
      - "pubspec.yaml"
      - ".github/workflows/android-release.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "lib/**"
      - "android/**"
      - "pubspec.yaml"
      - ".github/workflows/android-release.yml"
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build type"
        required: true
        default: "release"
        type: choice
        options:
          - release
          - debug
      upload_to_play_store:
        description: "Upload to Play Store"
        required: false
        default: false
        type: boolean
  release:
    types: [published]
    permissions:
      contents: write

env:
  FLUTTER_VERSION: "3.24.0"

jobs:
  build-android:
    name: Build XFâ‚² Wallet (Android)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: Enable Android support
        run: flutter config --enable-android

      - name: Download xfg-stark-cli
        run: |
          curl -L -o xfg-stark-cli-linux.tar.gz "https://github.com/ColinRitman/xfgwin/releases/download/v0.8.8/xfg-stark-cli-linux.tar.gz"
          tar -tzf xfg-stark-cli-linux.tar.gz
          tar -xzf xfg-stark-cli-linux.tar.gz
          ls -la
          find . -name "xfg-stark-cli" -type f
          BINARY_PATH=$(find . -name "xfg-stark-cli" -type f | head -1)
          echo "Found binary at: $BINARY_PATH"
          chmod +x "$BINARY_PATH"
          mkdir -p assets/bin
          mv "$BINARY_PATH" assets/bin/xfg-stark-cli-linux
          rm xfg-stark-cli-linux.tar.gz

      - name: Build fuego from source
        run: |
          # Clone HEAT branch
          git clone -b HEAT https://github.com/usexfg/fuego-suite.git fuego-source
          cd fuego-source

          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y build-essential git cmake libboost-all-dev libjsoncpp-dev libssl-dev libzmq3-dev

          # Build PaymentGateService (outputs to walletd)
          mkdir build && cd build
          cmake .. -DBUILD_TESTS=OFF -DJSONCPP_INCLUDE_DIR=/usr/include -DCMAKE_CXX_FLAGS="-I/usr/include"
          make -j$(nproc) PaymentGateService

          # Copy walletd binary
          mkdir -p ../../assets/bin
          cp src/walletd/walletd ../../assets/bin/fuego-walletd
          chmod +x ../../assets/bin/fuego-walletd

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Analyze code
        run: flutter analyze

      - name: Setup Android keystore
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
          echo "storeFile=keystore.jks" >> android/key.properties
          echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> android/key.properties

      - name: Build APK (Debug)
        if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'debug')
        run: flutter build apk --debug

      - name: Build APK (Release)
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd android
          ./gradlew assembleRelease
          cd ..

      - name: Build AAB (Release)
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd android
          ./gradlew bundleRelease
          cd ..

      - name: Sign APK with apksigner
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          # Use Android SDK's apksigner for proper signing
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks android/app/keystore.jks \
            --ks-key-alias ${{ secrets.ANDROID_KEY_ALIAS }} \
            --ks-pass pass:${{ secrets.ANDROID_STORE_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_KEY_PASSWORD }} \
            --out build/app/outputs/flutter-apk/app-release-signed.apk \
            build/app/outputs/flutter-apk/app-release.apk

      - name: Verify APK signature
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          $ANDROID_HOME/build-tools/34.0.0/apksigner verify build/app/outputs/flutter-apk/app-release-signed.apk

      - name: Create APK archive
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd build/app/outputs/flutter-apk
          if [ -f app-release-signed.apk ]; then
            cp app-release-signed.apk XFâ‚²-Wallet-Android-Release.apk
          else
            cp app-release.apk XFâ‚²-Wallet-Android-Release.apk
          fi
          zip -r XFâ‚²-Wallet-Android-Release.zip XFâ‚²-Wallet-Android-Release.apk

      - name: Create AAB archive
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        run: |
          cd build/app/outputs/bundle/release
          cp app-release.aab XFâ‚²-Wallet-Android-Release.aab
          zip -r XFâ‚²-Wallet-Android-Release-AAB.zip XFâ‚²-Wallet-Android-Release.aab

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-android-apk
          path: |
            build/app/outputs/flutter-apk/XFâ‚²-Wallet-Android-Release.zip
            build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      - name: Upload AAB artifacts
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-android-aab
          path: build/app/outputs/bundle/release/XFâ‚²-Wallet-Android-Release-AAB.zip
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            build/app/outputs/flutter-apk/XFâ‚²-Wallet-Android-Release.zip
            build/app/outputs/bundle/release/XFâ‚²-Wallet-Android-Release-AAB.zip
          tag_name: ${{ github.ref_name }}
          name: XFâ‚² Wallet Android Release ${{ github.ref_name }}

  upload-to-play-store:
    name: Upload to Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_play_store == 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-android-aab
          path: ./artifacts

      - name: Extract AAB
        run: |
          cd artifacts
          unzip XFâ‚²-Wallet-Android-Release-AAB.zip
          cd ..

      - name: Setup Google Play Console API
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.fuego.fuego_wallet
          releaseFiles: artifacts/XFâ‚²-Wallet-Android-Release.aab
          track: production
          status: completed
          inAppUpdatePriority: 2
          userFraction: 1.0

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-android
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'release')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: xfg-wallet-android-apk
          path: ./artifacts

      - name: Extract APK
        run: |
          cd artifacts
          unzip XFâ‚²-Wallet-Android-Release.zip
          cd ..

      - name: Run MobSF Security Scan
        uses: MobSF/MobSF-Action@v1.0.0
        with:
          file: artifacts/XFâ‚²-Wallet-Android-Release.apk
          mobsf_url: ${{ secrets.MOBSF_URL }}
          mobsf_api_key: ${{ secrets.MOBSF_API_KEY }}

  notify-release:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [build-android, upload-to-play-store]
    if: always() && github.event_name == 'release'

    steps:
      - name: Notify Discord
        if: env.DISCORD_WEBHOOK_URL != ''
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: |
            ðŸš€ **XFâ‚² Wallet Android Release ${{ github.ref_name }}**

            âœ… Android APK and AAB builds completed
            ðŸ“± Ready for distribution
            ðŸ”— [Download from GitHub Releases](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})

            **Build Details:**
            - Version: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}

      - name: Create Release Summary
        run: |
          echo "## XFâ‚² Wallet Android Release ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android APK: Built and signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Android AAB: Built and signed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security scan: Completed" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.upload-to-play-store.result }}" == "success" ]; then
            echo "- âœ… Play Store: Uploaded successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Play Store: Upload skipped or failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Android APK](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/XFâ‚²-Wallet-Android-Release.zip)" >> $GITHUB_STEP_SUMMARY
          echo "- [Android AAB](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/XFâ‚²-Wallet-Android-Release-AAB.zip)" >> $GITHUB_STEP_SUMMARY
