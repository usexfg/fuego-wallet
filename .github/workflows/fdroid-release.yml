name: XF₲ Wallet F-Droid Build

on:
  push:
    branches: [main, master]
    paths:
      - "lib/**"
      - "android/**"
      - "pubspec.yaml"
      - ".github/workflows/fdroid-release.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "lib/**"
      - "android/**"
      - "pubspec.yaml"
      - ".github/workflows/fdroid-release.yml"
  workflow_dispatch:
  release:
    types: [published]
    permissions:
      contents: write

env:
  FLUTTER_VERSION: "3.24.0"

jobs:
  build-fdroid-apk:
    name: Build F-Droid APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: Enable Android support
        run: flutter config --enable-android

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Rust cache
        uses: swatinem/rust-cache@v2

      - name: Build Rust crypto library
        run: |
          cd native/crypto
          cargo build --release --target aarch64-linux-android
          cargo build --release --target armv7-linux-androideabi
          cargo build --release --target i686-linux-android
          cargo build --release --target x86_64-linux-android

      - name: Copy Rust libraries to assets
        run: |
          mkdir -p assets/bin
          cp native/crypto/target/aarch64-linux-android/release/libfuego_crypto.so assets/bin/libfuego_crypto-arm64-v8a.so || true
          cp native/crypto/target/armv7-linux-androideabi/release/libfuego_crypto.so assets/bin/libfuego_crypto-armeabi-v7a.so || true
          cp native/crypto/target/i686-linux-android/release/libfuego_crypto.so assets/bin/libfuego_crypto-x86.so || true
          cp native/crypto/target/x86_64-linux-android/release/libfuego_crypto.so assets/bin/libfuego_crypto-x86_64.so || true

      - name: Download xfg-stark-cli
        run: |
          curl -L -o xfg-stark-cli-linux.tar.gz "https://github.com/ColinRitman/xfgwin/releases/download/v0.8.8/xfg-stark-cli-linux.tar.gz"
          tar -xzf xfg-stark-cli-linux.tar.gz
          mkdir -p assets/bin
          BINARY_PATH=$(find . -type f -name "xfg-stark-cli*" -perm -111 | head -n1 || true)
          if [ -z "$BINARY_PATH" ]; then
            BINARY_PATH=$(find . -type f -name "xfg-stark-cli*" | head -n1 || true)
          fi
          if [ -n "$BINARY_PATH" ]; then
            chmod +x "$BINARY_PATH"
            mv "$BINARY_PATH" assets/bin/xfg-stark-cli-linux
          else
            echo "xfg-stark-cli not found after extraction" >&2
            exit 1
          fi
          rm xfg-stark-cli-linux.tar.gz

      - name: Build fuego from source
        run: |
          # Clone HEAT branch
          git clone -b HEAT https://github.com/usexfg/fuego-suite.git fuego-source
          cd fuego-source

          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libboost-all-dev libssl-dev libzmq3-dev

          # Build walletd
          mkdir build && cd build
          cmake .. -DBUILD_ALL=ON -DBUILD_TESTS=OFF
          make -j$(nproc) walletd

          # Copy binary to assets
          mkdir -p ../../assets/bin
          cp src/walletd/walletd ../../assets/bin/fuego-walletd
          chmod +x ../../assets/bin/fuego-walletd

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Analyze code
        run: flutter analyze

      - name: Build APK (Release - Unsigned for F-Droid)
        run: flutter build apk --release

      - name: Build APK (Split per ABI for smaller size)
        run: flutter build apk --split-per-abi --release

      - name: Rename APK files
        run: |
          cd build/app/outputs/flutter-apk
          if [ -f app-release.apk ]; then
            cp app-release.apk XF₲-Wallet-FDroid-Release.apk
          fi
          if [ -f app-arm64-v8a-release.apk ]; then
            cp app-arm64-v8a-release.apk XF₲-Wallet-FDroid-Release-arm64-v8a.apk
            cp app-armeabi-v7a-release.apk XF₲-Wallet-FDroid-Release-armeabi-v7a.apk
            cp app-x86_64-release.apk XF₲-Wallet-FDroid-Release-x86_64.apk
          fi

      - name: Generate APK checksums
        run: |
          cd build/app/outputs/flutter-apk
          sha256sum *.apk > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xfg-wallet-fdroid-apk
          path: |
